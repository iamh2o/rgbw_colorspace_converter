<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.9.2" />
<title>pyramidtriangles.show_runner API documentation</title>
<meta name="description" content="ShowRunner is the primary thread. It maintains a status of what show(s) is running, when to change
shows, and display frames. The show runner can also …" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>pyramidtriangles.show_runner</code></h1>
</header>
<section id="section-intro">
<p>ShowRunner is the primary thread. It maintains a status of what show(s) is running, when to change
shows, and display frames. The show runner can also modulate overall brightness and speed.</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;
ShowRunner is the primary thread. It maintains a status of what show(s) is running, when to change
shows, and display frames. The show runner can also modulate overall brightness and speed.
&#34;&#34;&#34;
from __future__ import annotations
from collections.abc import Generator, Iterable, Mapping
from dataclasses import dataclass
from logging import getLogger
from queue import Queue, Empty
import sqlite3
import time
from threading import Event, Thread
from typing import Optional, Any


from . import util
from .grid import Pyramid
from .shows import load_shows, random_shows, Show, KnobValue
from .playlist import Playlist

logger = getLogger(__name__)


def make_interpolator():
    low_interp = util.make_interpolator(0.0, 0.5, 2.0, 1.0)
    hi_interp = util.make_interpolator(0.5, 1.0, 1.0, 0.5)

    def interpolation(val):
        &#34;&#34;&#34;
        Interpolation function to map OSC input into ShowRunner speed_x
        Values range from 0.0 to 1.0
        input 0.5 =&gt; 1.0
        input &lt; 0.5 ranges from 2.0 to 1.0
        input &gt; 0.5 ranges from 1.0 to 0.5
        &#34;&#34;&#34;
        if val == 0.5:
            return 1.0
        elif val &lt; 0.5:
            return low_interp(val)
        else:
            return hi_interp(val)
    return interpolation


speed_interpolation = make_interpolator()


class ShowRunner(Thread):
    def __init__(self,
                 pyramid: Pyramid,
                 command_queue: Queue,
                 status_queue: Queue,
                 shutdown: Event,
                 max_showtime: int,
                 fail_hard: bool):
        # Set thread name
        super(ShowRunner, self).__init__(name=type(self).__name__)

        self.pyramid = pyramid
        self.command_queue = command_queue
        self.status_queue = status_queue
        self.shutdown = shutdown
        self.__max_show_time = max_showtime
        self.fail_hard = fail_hard

        # default settings
        self.__brightness_scale = 1.0
        self.__speed_scale = 1.0
        self.show_start_time = 0.0

        # map of names -&gt; show constructors
        self.shows = dict(load_shows())
        self.random_show_sequence = random_shows()
        self.playlist = Playlist()

        # show state variables
        self.show: Optional[Show] = None
        self.prev_show: Optional[Show] = None
        self.framegen: Generator[float, None, None] = (_ for _ in ())

    def _send_status(self):
        &#34;&#34;&#34;
        Enqueue a status update in queue for consumers.
        &#34;&#34;&#34;
        status = self.status
        if status:
            self.status_queue.put(status)

    @property
    def status(self):
        &#34;&#34;&#34;
        Returns the status of the ShowRunner.
        &#34;&#34;&#34;
        if self.show is None:
            return None

        knobs_json = []
        if self.show.knobs:
            knobs_json = self.show.knobs.json_array

        # Represents JSON status object
        return Status(
            show=self.show.name,
            show_start_time=self.show_start_time,
            knobs=knobs_json,
            max_show_time=self.max_show_time,
            brightness_scale=self.brightness_scale,
            speed_scale=self.speed_scale)

    def process_command_queue(self):
        msgs = []
        while True:
            try:
                msgs.append(self.command_queue.get_nowait())
            except Empty:
                break
        [self._process_command(cmd) for cmd in msgs]

    def _process_command(self, msg):
        if isinstance(msg, ClearCmd):
            self.clear()
            self.shutdown.wait(2.0)
        elif isinstance(msg, RunShowCmd):
            self.next_show(msg.show)
        elif isinstance(msg, RuntimeCmd):
            self.max_show_time = msg.runtime
        elif isinstance(msg, BrightnessCmd):
            self.brightness_scale = msg.brightness
        elif isinstance(msg, SpeedCmd):
            self.speed_scale = msg.speed
        elif isinstance(msg, ShowKnobCmd):
            curr_show_name = self.show.name if self.show else &#39;&#39;
            if curr_show_name != msg.show:
                logger.info(&#39;Received knob value for show %s but show %s running&#39;, msg.show, curr_show_name)
                return
            if self.show.knobs:
                self.show.knobs[msg.name] = msg.value
        elif isinstance(msg, tuple):
            logger.debug(&#39;OSC: %s&#39;, msg)

            (addr, val) = msg
            addr = addr.split(&#39;/z&#39;)[0]
            val = val[0]
            assert addr[0] == &#39;/&#39;
            (ns, cmd) = addr[1:].split(&#39;/&#39;)
            if ns == &#39;1&#39;:
                # control command
                if cmd == &#39;next&#39;:
                    self.next_show()
                elif cmd == &#39;previous&#39;:
                    if self.prev_show:
                        self.next_show(self.prev_show.name)
                elif cmd == &#39;speed&#39;:
                    self.speed_scale = speed_interpolation(val)
                    logger.info(&#39;setting speed_x to: %f&#39;, self.speed_scale)

        else:
            logger.warning(&#39;ignoring unknown msg: %s&#39;, msg)

    def clear(self):
        &#34;&#34;&#34;Clears all panels.&#34;&#34;&#34;
        self.pyramid.clear()

    def next_show(self, name: Optional[str] = None):
        &#34;&#34;&#34;
        Sets the next show to run, in priority of:
            1. Show passed as `name` argument
            2. Show in playlist
            3. Show from semi-random sequence generator
        &#34;&#34;&#34;
        show_cls: Optional[type[Show]] = None
        if name:
            if name in self.shows:
                show_cls = self.shows[name]
            else:
                logger.warning(&#39;unknown show as argument: %s&#39;, name)

        if not show_cls:
            try:
                name = self.playlist.next()
            except sqlite3.DatabaseError as e:
                logger.error(&#39;error getting next show from playlist, skipping: %s&#39;, e)

            if name:
                if name in self.shows:
                    show_cls = self.shows[name]
                else:
                    logger.warning(&#39;unknown show from playlist: %s&#39;, name)

        if not show_cls:
            logger.info(&#34;choosing random show&#34;)
            (name, show_cls) = next(self.random_show_sequence)

        self.clear()
        self.prev_show = self.show

        logger.info(&#39;next show: %s&#39;, name)
        self.show = show_cls(self.pyramid)
        self.show_start_time = time.perf_counter()
        self.framegen = self.show.next_frame()
        self._send_status()

    def get_next_frame(self):
        &#34;&#34;&#34;return a delay or None&#34;&#34;&#34;
        try:
            return next(self.framegen)
        except StopIteration:
            return None

    def run(self):
        if not self.show or not self.framegen:
            logger.info(&#34;Next Next Next&#34;)
            self.next_show()

        # Loops until the shutdown event is triggered
        while not self.shutdown.is_set():
            try:
                self.process_command_queue()

                delay = self.get_next_frame()
                self.pyramid.go()
                if delay:
                    real_delay = delay * self.speed_scale
                    self.shutdown.wait(real_delay)  # shutdown.wait() is like time.sleep() but can be interrupted

                    now = time.perf_counter()
                    elapsed = now - self.show_start_time
                    if elapsed &gt; self.max_show_time:
                        logger.info(&#34;max show time elapsed, changing shows&#34;)
                        self.next_show()
                else:
                    logger.info(&#34;show is out of frames, waiting...&#34;)
                    self.shutdown.wait(2)
                    self.next_show()
            except KeyboardInterrupt:
                raise
            except Exception:
                logger.exception(&#39;unexpected exception in show loop while running %s&#39;, self.show.name)
                if self.fail_hard:
                    raise
                self.next_show()

    @property
    def max_show_time(self) -&gt; int:
        return self.__max_show_time

    @max_show_time.setter
    def max_show_time(self, show_time: int):
        &#34;&#34;&#34;Sets show_time, at least 5 seconds.&#34;&#34;&#34;
        self.__max_show_time = show_time if show_time &gt;= 5 else 5
        self._send_status()

    @property
    def brightness_scale(self) -&gt; float:
        return self.__brightness_scale

    @brightness_scale.setter
    def brightness_scale(self, brightness: float):
        &#34;&#34;&#34;Sets brightness in [0, 1].&#34;&#34;&#34;
        self.__brightness_scale = min(max(0.0, brightness), 1.0)
        self.pyramid.face.model.brightness = self.__brightness_scale
        self._send_status()

    @property
    def speed_scale(self) -&gt; float:
        return self.__speed_scale

    @speed_scale.setter
    def speed_scale(self, speed: float):
        &#34;&#34;&#34;Sets show speed multiplier in [0.5, 2.0], 1.0 is normal, lower is faster, higher is slower.&#34;&#34;&#34;
        self.__speed_scale = min(max(0.5, speed), 2.0)
        self._send_status()


@dataclass
class Status:
    &#34;&#34;&#34;Represents current status of ShowRunner&#34;&#34;&#34;
    show: str
    show_start_time: float
    max_show_time: int
    brightness_scale: float
    speed_scale: float
    # {show: [{knob1: {_some values_}}, ...]}
    knobs: Iterable[Mapping[str, Mapping[str, Any]]]
    seconds_remaining: int = 0


@dataclass(frozen=True)
class ClearCmd:
    &#34;&#34;&#34;Clears panels and waits a couple seconds.&#34;&#34;&#34;
    pass


@dataclass(frozen=True)
class RunShowCmd:
    &#34;&#34;&#34;Run this show now.&#34;&#34;&#34;
    show: Optional[str]


@dataclass(frozen=True)
class RuntimeCmd:
    &#34;&#34;&#34;Change show running time.&#34;&#34;&#34;
    runtime: int


@dataclass(frozen=True)
class BrightnessCmd:
    &#34;&#34;&#34;Change brightness scale in [0, 1].&#34;&#34;&#34;
    brightness: float


@dataclass(frozen=True)
class ShowKnobCmd:
    show: str
    name: str
    value: KnobValue


@dataclass(frozen=True)
class SpeedCmd:
    speed: float</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="pyramidtriangles.show_runner.make_interpolator"><code class="name flex">
<span>def <span class="ident">make_interpolator</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def make_interpolator():
    low_interp = util.make_interpolator(0.0, 0.5, 2.0, 1.0)
    hi_interp = util.make_interpolator(0.5, 1.0, 1.0, 0.5)

    def interpolation(val):
        &#34;&#34;&#34;
        Interpolation function to map OSC input into ShowRunner speed_x
        Values range from 0.0 to 1.0
        input 0.5 =&gt; 1.0
        input &lt; 0.5 ranges from 2.0 to 1.0
        input &gt; 0.5 ranges from 1.0 to 0.5
        &#34;&#34;&#34;
        if val == 0.5:
            return 1.0
        elif val &lt; 0.5:
            return low_interp(val)
        else:
            return hi_interp(val)
    return interpolation</code></pre>
</details>
</dd>
<dt id="pyramidtriangles.show_runner.speed_interpolation"><code class="name flex">
<span>def <span class="ident">speed_interpolation</span></span>(<span>val)</span>
</code></dt>
<dd>
<div class="desc"><p>Interpolation function to map OSC input into ShowRunner speed_x
Values range from 0.0 to 1.0
input 0.5 =&gt; 1.0
input &lt; 0.5 ranges from 2.0 to 1.0
input &gt; 0.5 ranges from 1.0 to 0.5</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def interpolation(val):
    &#34;&#34;&#34;
    Interpolation function to map OSC input into ShowRunner speed_x
    Values range from 0.0 to 1.0
    input 0.5 =&gt; 1.0
    input &lt; 0.5 ranges from 2.0 to 1.0
    input &gt; 0.5 ranges from 1.0 to 0.5
    &#34;&#34;&#34;
    if val == 0.5:
        return 1.0
    elif val &lt; 0.5:
        return low_interp(val)
    else:
        return hi_interp(val)</code></pre>
</details>
</dd>
</dl>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="pyramidtriangles.show_runner.BrightnessCmd"><code class="flex name class">
<span>class <span class="ident">BrightnessCmd</span></span>
<span>(</span><span>brightness: float)</span>
</code></dt>
<dd>
<div class="desc"><p>Change brightness scale in [0, 1].</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@dataclass(frozen=True)
class BrightnessCmd:
    &#34;&#34;&#34;Change brightness scale in [0, 1].&#34;&#34;&#34;
    brightness: float</code></pre>
</details>
<h3>Class variables</h3>
<dl>
<dt id="pyramidtriangles.show_runner.BrightnessCmd.brightness"><code class="name">var <span class="ident">brightness</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
</dl>
</dd>
<dt id="pyramidtriangles.show_runner.ClearCmd"><code class="flex name class">
<span>class <span class="ident">ClearCmd</span></span>
</code></dt>
<dd>
<div class="desc"><p>Clears panels and waits a couple seconds.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@dataclass(frozen=True)
class ClearCmd:
    &#34;&#34;&#34;Clears panels and waits a couple seconds.&#34;&#34;&#34;
    pass</code></pre>
</details>
</dd>
<dt id="pyramidtriangles.show_runner.RunShowCmd"><code class="flex name class">
<span>class <span class="ident">RunShowCmd</span></span>
<span>(</span><span>show: Optional[str])</span>
</code></dt>
<dd>
<div class="desc"><p>Run this show now.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@dataclass(frozen=True)
class RunShowCmd:
    &#34;&#34;&#34;Run this show now.&#34;&#34;&#34;
    show: Optional[str]</code></pre>
</details>
<h3>Class variables</h3>
<dl>
<dt id="pyramidtriangles.show_runner.RunShowCmd.show"><code class="name">var <span class="ident">show</span> : Optional[str]</code></dt>
<dd>
<div class="desc"></div>
</dd>
</dl>
</dd>
<dt id="pyramidtriangles.show_runner.RuntimeCmd"><code class="flex name class">
<span>class <span class="ident">RuntimeCmd</span></span>
<span>(</span><span>runtime: int)</span>
</code></dt>
<dd>
<div class="desc"><p>Change show running time.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@dataclass(frozen=True)
class RuntimeCmd:
    &#34;&#34;&#34;Change show running time.&#34;&#34;&#34;
    runtime: int</code></pre>
</details>
<h3>Class variables</h3>
<dl>
<dt id="pyramidtriangles.show_runner.RuntimeCmd.runtime"><code class="name">var <span class="ident">runtime</span> : int</code></dt>
<dd>
<div class="desc"></div>
</dd>
</dl>
</dd>
<dt id="pyramidtriangles.show_runner.ShowKnobCmd"><code class="flex name class">
<span>class <span class="ident">ShowKnobCmd</span></span>
<span>(</span><span>show: str, name: str, value: KnobValue)</span>
</code></dt>
<dd>
<div class="desc"><p>ShowKnobCmd(show: 'str', name: 'str', value: 'KnobValue')</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@dataclass(frozen=True)
class ShowKnobCmd:
    show: str
    name: str
    value: KnobValue</code></pre>
</details>
<h3>Class variables</h3>
<dl>
<dt id="pyramidtriangles.show_runner.ShowKnobCmd.name"><code class="name">var <span class="ident">name</span> : str</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="pyramidtriangles.show_runner.ShowKnobCmd.show"><code class="name">var <span class="ident">show</span> : str</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="pyramidtriangles.show_runner.ShowKnobCmd.value"><code class="name">var <span class="ident">value</span> : Union[int, float, <a title="pyramidtriangles.model.DisplayColor" href="model/index.html#pyramidtriangles.model.DisplayColor">DisplayColor</a>]</code></dt>
<dd>
<div class="desc"></div>
</dd>
</dl>
</dd>
<dt id="pyramidtriangles.show_runner.ShowRunner"><code class="flex name class">
<span>class <span class="ident">ShowRunner</span></span>
<span>(</span><span>pyramid: Pyramid, command_queue: Queue, status_queue: Queue, shutdown: Event, max_showtime: int, fail_hard: bool)</span>
</code></dt>
<dd>
<div class="desc"><p>A class that represents a thread of control.</p>
<p>This class can be safely subclassed in a limited fashion. There are two ways
to specify the activity: by passing a callable object to the constructor, or
by overriding the run() method in a subclass.</p>
<p>This constructor should always be called with keyword arguments. Arguments are:</p>
<p><em>group</em> should be None; reserved for future extension when a ThreadGroup
class is implemented.</p>
<p><em>target</em> is the callable object to be invoked by the run()
method. Defaults to None, meaning nothing is called.</p>
<p><em>name</em> is the thread name. By default, a unique name is constructed of
the form "Thread-N" where N is a small decimal number.</p>
<p><em>args</em> is the argument tuple for the target invocation. Defaults to ().</p>
<p><em>kwargs</em> is a dictionary of keyword arguments for the target
invocation. Defaults to {}.</p>
<p>If a subclass overrides the constructor, it must make sure to invoke
the base class constructor (Thread.<strong>init</strong>()) before doing anything
else to the thread.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class ShowRunner(Thread):
    def __init__(self,
                 pyramid: Pyramid,
                 command_queue: Queue,
                 status_queue: Queue,
                 shutdown: Event,
                 max_showtime: int,
                 fail_hard: bool):
        # Set thread name
        super(ShowRunner, self).__init__(name=type(self).__name__)

        self.pyramid = pyramid
        self.command_queue = command_queue
        self.status_queue = status_queue
        self.shutdown = shutdown
        self.__max_show_time = max_showtime
        self.fail_hard = fail_hard

        # default settings
        self.__brightness_scale = 1.0
        self.__speed_scale = 1.0
        self.show_start_time = 0.0

        # map of names -&gt; show constructors
        self.shows = dict(load_shows())
        self.random_show_sequence = random_shows()
        self.playlist = Playlist()

        # show state variables
        self.show: Optional[Show] = None
        self.prev_show: Optional[Show] = None
        self.framegen: Generator[float, None, None] = (_ for _ in ())

    def _send_status(self):
        &#34;&#34;&#34;
        Enqueue a status update in queue for consumers.
        &#34;&#34;&#34;
        status = self.status
        if status:
            self.status_queue.put(status)

    @property
    def status(self):
        &#34;&#34;&#34;
        Returns the status of the ShowRunner.
        &#34;&#34;&#34;
        if self.show is None:
            return None

        knobs_json = []
        if self.show.knobs:
            knobs_json = self.show.knobs.json_array

        # Represents JSON status object
        return Status(
            show=self.show.name,
            show_start_time=self.show_start_time,
            knobs=knobs_json,
            max_show_time=self.max_show_time,
            brightness_scale=self.brightness_scale,
            speed_scale=self.speed_scale)

    def process_command_queue(self):
        msgs = []
        while True:
            try:
                msgs.append(self.command_queue.get_nowait())
            except Empty:
                break
        [self._process_command(cmd) for cmd in msgs]

    def _process_command(self, msg):
        if isinstance(msg, ClearCmd):
            self.clear()
            self.shutdown.wait(2.0)
        elif isinstance(msg, RunShowCmd):
            self.next_show(msg.show)
        elif isinstance(msg, RuntimeCmd):
            self.max_show_time = msg.runtime
        elif isinstance(msg, BrightnessCmd):
            self.brightness_scale = msg.brightness
        elif isinstance(msg, SpeedCmd):
            self.speed_scale = msg.speed
        elif isinstance(msg, ShowKnobCmd):
            curr_show_name = self.show.name if self.show else &#39;&#39;
            if curr_show_name != msg.show:
                logger.info(&#39;Received knob value for show %s but show %s running&#39;, msg.show, curr_show_name)
                return
            if self.show.knobs:
                self.show.knobs[msg.name] = msg.value
        elif isinstance(msg, tuple):
            logger.debug(&#39;OSC: %s&#39;, msg)

            (addr, val) = msg
            addr = addr.split(&#39;/z&#39;)[0]
            val = val[0]
            assert addr[0] == &#39;/&#39;
            (ns, cmd) = addr[1:].split(&#39;/&#39;)
            if ns == &#39;1&#39;:
                # control command
                if cmd == &#39;next&#39;:
                    self.next_show()
                elif cmd == &#39;previous&#39;:
                    if self.prev_show:
                        self.next_show(self.prev_show.name)
                elif cmd == &#39;speed&#39;:
                    self.speed_scale = speed_interpolation(val)
                    logger.info(&#39;setting speed_x to: %f&#39;, self.speed_scale)

        else:
            logger.warning(&#39;ignoring unknown msg: %s&#39;, msg)

    def clear(self):
        &#34;&#34;&#34;Clears all panels.&#34;&#34;&#34;
        self.pyramid.clear()

    def next_show(self, name: Optional[str] = None):
        &#34;&#34;&#34;
        Sets the next show to run, in priority of:
            1. Show passed as `name` argument
            2. Show in playlist
            3. Show from semi-random sequence generator
        &#34;&#34;&#34;
        show_cls: Optional[type[Show]] = None
        if name:
            if name in self.shows:
                show_cls = self.shows[name]
            else:
                logger.warning(&#39;unknown show as argument: %s&#39;, name)

        if not show_cls:
            try:
                name = self.playlist.next()
            except sqlite3.DatabaseError as e:
                logger.error(&#39;error getting next show from playlist, skipping: %s&#39;, e)

            if name:
                if name in self.shows:
                    show_cls = self.shows[name]
                else:
                    logger.warning(&#39;unknown show from playlist: %s&#39;, name)

        if not show_cls:
            logger.info(&#34;choosing random show&#34;)
            (name, show_cls) = next(self.random_show_sequence)

        self.clear()
        self.prev_show = self.show

        logger.info(&#39;next show: %s&#39;, name)
        self.show = show_cls(self.pyramid)
        self.show_start_time = time.perf_counter()
        self.framegen = self.show.next_frame()
        self._send_status()

    def get_next_frame(self):
        &#34;&#34;&#34;return a delay or None&#34;&#34;&#34;
        try:
            return next(self.framegen)
        except StopIteration:
            return None

    def run(self):
        if not self.show or not self.framegen:
            logger.info(&#34;Next Next Next&#34;)
            self.next_show()

        # Loops until the shutdown event is triggered
        while not self.shutdown.is_set():
            try:
                self.process_command_queue()

                delay = self.get_next_frame()
                self.pyramid.go()
                if delay:
                    real_delay = delay * self.speed_scale
                    self.shutdown.wait(real_delay)  # shutdown.wait() is like time.sleep() but can be interrupted

                    now = time.perf_counter()
                    elapsed = now - self.show_start_time
                    if elapsed &gt; self.max_show_time:
                        logger.info(&#34;max show time elapsed, changing shows&#34;)
                        self.next_show()
                else:
                    logger.info(&#34;show is out of frames, waiting...&#34;)
                    self.shutdown.wait(2)
                    self.next_show()
            except KeyboardInterrupt:
                raise
            except Exception:
                logger.exception(&#39;unexpected exception in show loop while running %s&#39;, self.show.name)
                if self.fail_hard:
                    raise
                self.next_show()

    @property
    def max_show_time(self) -&gt; int:
        return self.__max_show_time

    @max_show_time.setter
    def max_show_time(self, show_time: int):
        &#34;&#34;&#34;Sets show_time, at least 5 seconds.&#34;&#34;&#34;
        self.__max_show_time = show_time if show_time &gt;= 5 else 5
        self._send_status()

    @property
    def brightness_scale(self) -&gt; float:
        return self.__brightness_scale

    @brightness_scale.setter
    def brightness_scale(self, brightness: float):
        &#34;&#34;&#34;Sets brightness in [0, 1].&#34;&#34;&#34;
        self.__brightness_scale = min(max(0.0, brightness), 1.0)
        self.pyramid.face.model.brightness = self.__brightness_scale
        self._send_status()

    @property
    def speed_scale(self) -&gt; float:
        return self.__speed_scale

    @speed_scale.setter
    def speed_scale(self, speed: float):
        &#34;&#34;&#34;Sets show speed multiplier in [0.5, 2.0], 1.0 is normal, lower is faster, higher is slower.&#34;&#34;&#34;
        self.__speed_scale = min(max(0.5, speed), 2.0)
        self._send_status()</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li>threading.Thread</li>
</ul>
<h3>Instance variables</h3>
<dl>
<dt id="pyramidtriangles.show_runner.ShowRunner.brightness_scale"><code class="name">var <span class="ident">brightness_scale</span> : float</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@property
def brightness_scale(self) -&gt; float:
    return self.__brightness_scale</code></pre>
</details>
</dd>
<dt id="pyramidtriangles.show_runner.ShowRunner.max_show_time"><code class="name">var <span class="ident">max_show_time</span> : int</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@property
def max_show_time(self) -&gt; int:
    return self.__max_show_time</code></pre>
</details>
</dd>
<dt id="pyramidtriangles.show_runner.ShowRunner.speed_scale"><code class="name">var <span class="ident">speed_scale</span> : float</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@property
def speed_scale(self) -&gt; float:
    return self.__speed_scale</code></pre>
</details>
</dd>
<dt id="pyramidtriangles.show_runner.ShowRunner.status"><code class="name">var <span class="ident">status</span></code></dt>
<dd>
<div class="desc"><p>Returns the status of the ShowRunner.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@property
def status(self):
    &#34;&#34;&#34;
    Returns the status of the ShowRunner.
    &#34;&#34;&#34;
    if self.show is None:
        return None

    knobs_json = []
    if self.show.knobs:
        knobs_json = self.show.knobs.json_array

    # Represents JSON status object
    return Status(
        show=self.show.name,
        show_start_time=self.show_start_time,
        knobs=knobs_json,
        max_show_time=self.max_show_time,
        brightness_scale=self.brightness_scale,
        speed_scale=self.speed_scale)</code></pre>
</details>
</dd>
</dl>
<h3>Methods</h3>
<dl>
<dt id="pyramidtriangles.show_runner.ShowRunner.clear"><code class="name flex">
<span>def <span class="ident">clear</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Clears all panels.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def clear(self):
    &#34;&#34;&#34;Clears all panels.&#34;&#34;&#34;
    self.pyramid.clear()</code></pre>
</details>
</dd>
<dt id="pyramidtriangles.show_runner.ShowRunner.get_next_frame"><code class="name flex">
<span>def <span class="ident">get_next_frame</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>return a delay or None</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_next_frame(self):
    &#34;&#34;&#34;return a delay or None&#34;&#34;&#34;
    try:
        return next(self.framegen)
    except StopIteration:
        return None</code></pre>
</details>
</dd>
<dt id="pyramidtriangles.show_runner.ShowRunner.next_show"><code class="name flex">
<span>def <span class="ident">next_show</span></span>(<span>self, name: Optional[str] = None)</span>
</code></dt>
<dd>
<div class="desc"><p>Sets the next show to run, in priority of:
1. Show passed as <code>name</code> argument
2. Show in playlist
3. Show from semi-random sequence generator</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def next_show(self, name: Optional[str] = None):
    &#34;&#34;&#34;
    Sets the next show to run, in priority of:
        1. Show passed as `name` argument
        2. Show in playlist
        3. Show from semi-random sequence generator
    &#34;&#34;&#34;
    show_cls: Optional[type[Show]] = None
    if name:
        if name in self.shows:
            show_cls = self.shows[name]
        else:
            logger.warning(&#39;unknown show as argument: %s&#39;, name)

    if not show_cls:
        try:
            name = self.playlist.next()
        except sqlite3.DatabaseError as e:
            logger.error(&#39;error getting next show from playlist, skipping: %s&#39;, e)

        if name:
            if name in self.shows:
                show_cls = self.shows[name]
            else:
                logger.warning(&#39;unknown show from playlist: %s&#39;, name)

    if not show_cls:
        logger.info(&#34;choosing random show&#34;)
        (name, show_cls) = next(self.random_show_sequence)

    self.clear()
    self.prev_show = self.show

    logger.info(&#39;next show: %s&#39;, name)
    self.show = show_cls(self.pyramid)
    self.show_start_time = time.perf_counter()
    self.framegen = self.show.next_frame()
    self._send_status()</code></pre>
</details>
</dd>
<dt id="pyramidtriangles.show_runner.ShowRunner.process_command_queue"><code class="name flex">
<span>def <span class="ident">process_command_queue</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def process_command_queue(self):
    msgs = []
    while True:
        try:
            msgs.append(self.command_queue.get_nowait())
        except Empty:
            break
    [self._process_command(cmd) for cmd in msgs]</code></pre>
</details>
</dd>
<dt id="pyramidtriangles.show_runner.ShowRunner.run"><code class="name flex">
<span>def <span class="ident">run</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Method representing the thread's activity.</p>
<p>You may override this method in a subclass. The standard run() method
invokes the callable object passed to the object's constructor as the
target argument, if any, with sequential and keyword arguments taken
from the args and kwargs arguments, respectively.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def run(self):
    if not self.show or not self.framegen:
        logger.info(&#34;Next Next Next&#34;)
        self.next_show()

    # Loops until the shutdown event is triggered
    while not self.shutdown.is_set():
        try:
            self.process_command_queue()

            delay = self.get_next_frame()
            self.pyramid.go()
            if delay:
                real_delay = delay * self.speed_scale
                self.shutdown.wait(real_delay)  # shutdown.wait() is like time.sleep() but can be interrupted

                now = time.perf_counter()
                elapsed = now - self.show_start_time
                if elapsed &gt; self.max_show_time:
                    logger.info(&#34;max show time elapsed, changing shows&#34;)
                    self.next_show()
            else:
                logger.info(&#34;show is out of frames, waiting...&#34;)
                self.shutdown.wait(2)
                self.next_show()
        except KeyboardInterrupt:
            raise
        except Exception:
            logger.exception(&#39;unexpected exception in show loop while running %s&#39;, self.show.name)
            if self.fail_hard:
                raise
            self.next_show()</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="pyramidtriangles.show_runner.SpeedCmd"><code class="flex name class">
<span>class <span class="ident">SpeedCmd</span></span>
<span>(</span><span>speed: float)</span>
</code></dt>
<dd>
<div class="desc"><p>SpeedCmd(speed: 'float')</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@dataclass(frozen=True)
class SpeedCmd:
    speed: float</code></pre>
</details>
<h3>Class variables</h3>
<dl>
<dt id="pyramidtriangles.show_runner.SpeedCmd.speed"><code class="name">var <span class="ident">speed</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
</dl>
</dd>
<dt id="pyramidtriangles.show_runner.Status"><code class="flex name class">
<span>class <span class="ident">Status</span></span>
<span>(</span><span>show: str, show_start_time: float, max_show_time: int, brightness_scale: float, speed_scale: float, knobs: Iterable[Mapping[str, Mapping[str, Any]]], seconds_remaining: int = 0)</span>
</code></dt>
<dd>
<div class="desc"><p>Represents current status of ShowRunner</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@dataclass
class Status:
    &#34;&#34;&#34;Represents current status of ShowRunner&#34;&#34;&#34;
    show: str
    show_start_time: float
    max_show_time: int
    brightness_scale: float
    speed_scale: float
    # {show: [{knob1: {_some values_}}, ...]}
    knobs: Iterable[Mapping[str, Mapping[str, Any]]]
    seconds_remaining: int = 0</code></pre>
</details>
<h3>Class variables</h3>
<dl>
<dt id="pyramidtriangles.show_runner.Status.brightness_scale"><code class="name">var <span class="ident">brightness_scale</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="pyramidtriangles.show_runner.Status.knobs"><code class="name">var <span class="ident">knobs</span> : collections.abc.Iterable</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="pyramidtriangles.show_runner.Status.max_show_time"><code class="name">var <span class="ident">max_show_time</span> : int</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="pyramidtriangles.show_runner.Status.seconds_remaining"><code class="name">var <span class="ident">seconds_remaining</span> : int</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="pyramidtriangles.show_runner.Status.show"><code class="name">var <span class="ident">show</span> : str</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="pyramidtriangles.show_runner.Status.show_start_time"><code class="name">var <span class="ident">show_start_time</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="pyramidtriangles.show_runner.Status.speed_scale"><code class="name">var <span class="ident">speed_scale</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="pyramidtriangles" href="index.html">pyramidtriangles</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="pyramidtriangles.show_runner.make_interpolator" href="#pyramidtriangles.show_runner.make_interpolator">make_interpolator</a></code></li>
<li><code><a title="pyramidtriangles.show_runner.speed_interpolation" href="#pyramidtriangles.show_runner.speed_interpolation">speed_interpolation</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="pyramidtriangles.show_runner.BrightnessCmd" href="#pyramidtriangles.show_runner.BrightnessCmd">BrightnessCmd</a></code></h4>
<ul class="">
<li><code><a title="pyramidtriangles.show_runner.BrightnessCmd.brightness" href="#pyramidtriangles.show_runner.BrightnessCmd.brightness">brightness</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="pyramidtriangles.show_runner.ClearCmd" href="#pyramidtriangles.show_runner.ClearCmd">ClearCmd</a></code></h4>
</li>
<li>
<h4><code><a title="pyramidtriangles.show_runner.RunShowCmd" href="#pyramidtriangles.show_runner.RunShowCmd">RunShowCmd</a></code></h4>
<ul class="">
<li><code><a title="pyramidtriangles.show_runner.RunShowCmd.show" href="#pyramidtriangles.show_runner.RunShowCmd.show">show</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="pyramidtriangles.show_runner.RuntimeCmd" href="#pyramidtriangles.show_runner.RuntimeCmd">RuntimeCmd</a></code></h4>
<ul class="">
<li><code><a title="pyramidtriangles.show_runner.RuntimeCmd.runtime" href="#pyramidtriangles.show_runner.RuntimeCmd.runtime">runtime</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="pyramidtriangles.show_runner.ShowKnobCmd" href="#pyramidtriangles.show_runner.ShowKnobCmd">ShowKnobCmd</a></code></h4>
<ul class="">
<li><code><a title="pyramidtriangles.show_runner.ShowKnobCmd.name" href="#pyramidtriangles.show_runner.ShowKnobCmd.name">name</a></code></li>
<li><code><a title="pyramidtriangles.show_runner.ShowKnobCmd.show" href="#pyramidtriangles.show_runner.ShowKnobCmd.show">show</a></code></li>
<li><code><a title="pyramidtriangles.show_runner.ShowKnobCmd.value" href="#pyramidtriangles.show_runner.ShowKnobCmd.value">value</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="pyramidtriangles.show_runner.ShowRunner" href="#pyramidtriangles.show_runner.ShowRunner">ShowRunner</a></code></h4>
<ul class="">
<li><code><a title="pyramidtriangles.show_runner.ShowRunner.brightness_scale" href="#pyramidtriangles.show_runner.ShowRunner.brightness_scale">brightness_scale</a></code></li>
<li><code><a title="pyramidtriangles.show_runner.ShowRunner.clear" href="#pyramidtriangles.show_runner.ShowRunner.clear">clear</a></code></li>
<li><code><a title="pyramidtriangles.show_runner.ShowRunner.get_next_frame" href="#pyramidtriangles.show_runner.ShowRunner.get_next_frame">get_next_frame</a></code></li>
<li><code><a title="pyramidtriangles.show_runner.ShowRunner.max_show_time" href="#pyramidtriangles.show_runner.ShowRunner.max_show_time">max_show_time</a></code></li>
<li><code><a title="pyramidtriangles.show_runner.ShowRunner.next_show" href="#pyramidtriangles.show_runner.ShowRunner.next_show">next_show</a></code></li>
<li><code><a title="pyramidtriangles.show_runner.ShowRunner.process_command_queue" href="#pyramidtriangles.show_runner.ShowRunner.process_command_queue">process_command_queue</a></code></li>
<li><code><a title="pyramidtriangles.show_runner.ShowRunner.run" href="#pyramidtriangles.show_runner.ShowRunner.run">run</a></code></li>
<li><code><a title="pyramidtriangles.show_runner.ShowRunner.speed_scale" href="#pyramidtriangles.show_runner.ShowRunner.speed_scale">speed_scale</a></code></li>
<li><code><a title="pyramidtriangles.show_runner.ShowRunner.status" href="#pyramidtriangles.show_runner.ShowRunner.status">status</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="pyramidtriangles.show_runner.SpeedCmd" href="#pyramidtriangles.show_runner.SpeedCmd">SpeedCmd</a></code></h4>
<ul class="">
<li><code><a title="pyramidtriangles.show_runner.SpeedCmd.speed" href="#pyramidtriangles.show_runner.SpeedCmd.speed">speed</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="pyramidtriangles.show_runner.Status" href="#pyramidtriangles.show_runner.Status">Status</a></code></h4>
<ul class="two-column">
<li><code><a title="pyramidtriangles.show_runner.Status.brightness_scale" href="#pyramidtriangles.show_runner.Status.brightness_scale">brightness_scale</a></code></li>
<li><code><a title="pyramidtriangles.show_runner.Status.knobs" href="#pyramidtriangles.show_runner.Status.knobs">knobs</a></code></li>
<li><code><a title="pyramidtriangles.show_runner.Status.max_show_time" href="#pyramidtriangles.show_runner.Status.max_show_time">max_show_time</a></code></li>
<li><code><a title="pyramidtriangles.show_runner.Status.seconds_remaining" href="#pyramidtriangles.show_runner.Status.seconds_remaining">seconds_remaining</a></code></li>
<li><code><a title="pyramidtriangles.show_runner.Status.show" href="#pyramidtriangles.show_runner.Status.show">show</a></code></li>
<li><code><a title="pyramidtriangles.show_runner.Status.show_start_time" href="#pyramidtriangles.show_runner.Status.show_start_time">show_start_time</a></code></li>
<li><code><a title="pyramidtriangles.show_runner.Status.speed_scale" href="#pyramidtriangles.show_runner.Status.speed_scale">speed_scale</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.9.2</a>.</p>
</footer>
</body>
</html>